{% extends "base.html" %}
{% block content %}

<div class="card text-center mb-4 shadow-sm border-primary">
    <div class="card-header bg-primary text-white fw-bold">ğŸ§¹ ESCOBA DEL DÃA ({{ hoy_dia }})</div>
    <div class="card-body">
        <h1 class="display-3 fw-bold text-dark">{{ escoba1 }}</h1>
        {% if escoba2 %}<div class="mt-2 p-2 bg-warning bg-opacity-25 border border-warning rounded"><span class="badge bg-warning text-dark mb-1">REFUERZO / 2Âº FURGONETA</span><h2 class="fw-bold text-dark">{{ escoba2 }}</h2></div>{% endif %}
        {% if user.role == 'Supervisor' %}
            <div class="mt-4 d-flex justify-content-center gap-2">
                <form action="/admin/next_turn" method="POST"><button type="submit" class="btn btn-danger btn-lg" onclick="return confirm('Â¿Rotar turno?')">ğŸ”„ CALCULAR SIGUIENTE</button></form>
                {% if escoba1 != 'Ninguno' and not escoba2 %}<form action="/admin/add_extra_turn" method="POST"><button type="submit" class="btn btn-outline-success btn-lg" onclick="return confirm('Â¿AÃ±adir refuerzo?')">â• AÃ‘ADIR REFUERZO</button></form>{% endif %}
            </div>
        {% endif %}
    </div>
</div>

{% if user.role == 'Conductor' %}<div class="card mb-4 shadow border-warning"><div class="card-body d-flex justify-content-between align-items-center"><div><h5 class="mb-1">{{ user.name }}</h5><small class="text-muted">DÃ­as Off: {{ user.fixed_days_off }}</small></div><form action="/update_status" method="POST"><select name="status" class="form-select fw-bold form-select-sm" onchange="this.form.submit()"><option value="Activo" {% if user.current_status == 'Activo' %}selected{% endif %}>ğŸŸ¢ Activo</option><option value="Vacaciones" {% if user.current_status == 'Vacaciones' %}selected{% endif %}>âœˆï¸ Vacaciones</option><option value="Baja Laboral" {% if user.current_status == 'Baja Laboral' %}selected{% endif %}>ğŸš‘ Baja</option><option value="Libre" {% if user.current_status == 'Libre' %}selected{% endif %}>ğŸ”µ Asuntos</option></select></form></div></div>{% endif %}

{% if user.role == 'Supervisor' %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h6 class="text-muted text-uppercase small fw-bold mb-0">Plantilla de Conductores</h6>
    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalAddDriver">ğŸ‘¤ Nuevo Conductor</button>
</div>
{% else %}<h6 class="text-muted text-uppercase small fw-bold mb-3">Cola de RotaciÃ³n (AntigÃ¼edad)</h6>{% endif %}

<div class="row">
    {% for d in drivers %}
    <div class="col-12 col-md-6 mb-2">
        <div class="card h-100 {% if d.name == escoba1 or d.name == escoba2 %}border-success bg-light{% endif %}">
            <div class="card-body p-2 d-flex justify-content-between align-items-center">
                <div>
                    <div class="fw-bold">{{ d.name }}</div>
                    <div class="small text-muted">Ãšltima vez: {% if d.last_escoba_date %}<span class="text-dark fw-bold">{{ d.last_escoba_date.strftime('%d/%m') }}</span>{% else %}<span class="text-danger fw-bold">NUNCA</span>{% endif %}</div>
                </div>
                <div class="text-end d-flex align-items-center gap-2">
                    {% if user.role == 'Supervisor' %}
                        <form action="/admin/force_status_change/{{ d.id }}" method="POST">
                            <select name="status" class="form-select form-select-sm fw-bold border-0 {% if d.current_status == 'Activo' %}bg-success text-white{% elif d.current_status == 'Baja Laboral' %}bg-danger text-white{% else %}bg-warning text-dark{% endif %}" onchange="this.form.submit()" style="width: auto; cursor: pointer;">
                                <option value="Activo" {% if d.current_status == 'Activo' %}selected{% endif %}>ğŸŸ¢ Activo</option>
                                <option value="Vacaciones" {% if d.current_status == 'Vacaciones' %}selected{% endif %}>âœˆï¸ Vacaciones</option>
                                <option value="Baja Laboral" {% if d.current_status == 'Baja Laboral' %}selected{% endif %}>ğŸš‘ Baja</option>
                                <option value="Libre" {% if d.current_status == 'Libre' %}selected{% endif %}>ğŸ”µ Asuntos</option>
                            </select>
                        </form>
                    {% else %}
                        <span class="badge {% if d.current_status == 'Activo' %}bg-success{% else %}bg-secondary{% endif %}">{{ d.current_status }}</span>
                    {% endif %}

                    {% if d.name == escoba1 %}<span class="fs-1">ğŸ§¹</span>{% elif d.name == escoba2 %}<span class="fs-1">ğŸš</span>{% endif %}
                    
                    {% if user.role == 'Supervisor' %}
                    <form action="/admin/delete_driver/{{ d.id }}" method="POST">
                        <button type="submit" class="btn btn-outline-danger btn-sm py-0 px-1" style="font-size: 0.7rem;" onclick="return confirm('Â¿Eliminar a {{ d.name }}?')">ğŸ—‘ï¸</button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% if user.role == 'Supervisor' %}
<div class="modal fade" id="modalAddDriver" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">Contratar Nuevo Conductor</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form action="/admin/add_driver" method="POST"><div class="mb-3"><label class="form-label">Nombre</label><input type="text" name="new_driver_name" class="form-control" required placeholder="Ej: PEDRO P."></div><button type="submit" class="btn btn-primary w-100">Crear</button></form></div></div></div></div>
<hr class="mt-5"><div class="accordion" id="accordionPin"><div class="accordion-item border-danger"><h2 class="accordion-header"><button class="accordion-button collapsed bg-danger text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePin">ğŸ‘®â€â™‚ï¸ CÃ“DIGOS PIN</button></h2><div id="collapsePin" class="accordion-collapse collapse"><div class="accordion-body p-0"><table class="table table-striped table-sm mb-0 text-center small"><thead class="table-dark"><tr><th>Conductor</th><th>PIN</th><th>AcciÃ³n</th></tr></thead><tbody>{% for d in drivers %}<tr><td class="text-start fw-bold ps-3">{{ d.name }}</td><td class="font-monospace text-danger fw-bold fs-5">{{ d.signup_pin }}</td><td>{% if d.is_registered %}<span class="badge bg-success">Registrado âœ…</span>{% else %}<a href="https://wa.me/?text=Hola%20{{ d.name }},%20bienvenido%20a%20Escoba%20Drives.%20ğŸšŒ%0A%0ATu%20PIN%20de%20seguridad%20es:%20*{{ d.signup_pin }}*%0A%0AEntra%20y%20regÃ­strate%20aquÃ­:%0Ahttps://Yoeph.pythonanywhere.com" target="_blank" class="btn btn-sm btn-success fw-bold">ğŸ“² Enviar PIN</a>{% endif %}</td></tr>{% endfor %}</tbody></table></div></div></div></div>{% endif %}
{% endblock %}